package keystrokesmod.module.impl.exploit.remoteshop;

import keystrokesmod.event.player.PostMotionEvent;
import keystrokesmod.event.player.PreMotionEvent;
import keystrokesmod.event.network.SendPacketEvent;
import keystrokesmod.module.impl.exploit.RemoteShop;
import keystrokesmod.utility.MoveUtil;
import keystrokesmod.utility.PacketUtils;
import net.minecraft.network.play.client.C0DPacketCloseWindow;
import net.minecraft.network.play.client.C0EPacketClickWindow;
import keystrokesmod.eventbus.annotations.EventListener;
import org.jetbrains.annotations.NotNull;

import java.util.Queue;
import java.util.concurrent.ConcurrentLinkedQueue;

public class HypixelRemoteShop extends IRemoteShop {
    private final Queue<C0EPacketClickWindow> delayedPacket = new ConcurrentLinkedQueue<>();
    private boolean lastStop = false;

    public HypixelRemoteShop(String name, @NotNull RemoteShop parent) {
        super(name, parent);
    }

    @EventListener
    public void onPreMotion(PreMotionEvent event) {
        if (mc.currentScreen == cacheShop && cacheShop != null) {
            synchronized (delayedPacket) {
                for (C0EPacketClickWindow p : delayedPacket) {
                    PacketUtils.sendPacketNoEvent(p);
                }
                delayedPacket.clear();
            }
        } else {
            delayedPacket.clear();
        }
    }

    @EventListener
    public void onPostMotion(PostMotionEvent event) {
        if (lastStop) {
            MoveUtil.stop();
            lastStop = false;
        }
    }

    @Override
    public void openContainer() {
        super.openContainer();
    }

    @Override
    public void remoteShop() {
        MoveUtil.stop();
        super.remoteShop();
    }

    @EventListener
    public void onSendPacket(SendPacketEvent event) {
        if (mc.currentScreen == cacheShop && cacheShop != null) {
            if (event.getPacket() instanceof C0EPacketClickWindow) {
                if (!lastStop) {
                    MoveUtil.stop();
                    lastStop = true;
                    delayedPacket.add((C0EPacketClickWindow) event.getPacket());
                    event.cancel();
                } else if (!delayedPacket.isEmpty()) {
                    delayedPacket.add((C0EPacketClickWindow) event.getPacket());
                    event.cancel();
                }
            } else if (event.getPacket() instanceof C0DPacketCloseWindow) {
                event.cancel();
            }
        }
    }

    @Override
    public void onDisable() throws Throwable {
        lastStop = false;
        delayedPacket.clear();
    }
}
